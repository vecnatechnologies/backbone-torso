!function(e,t){"function"==typeof define&&define.amd?define(["underscore","backbone"],t):"object"==typeof exports?module.exports=t(require("underscore"),require("backbone")):(e.Torso=e.Torso||{},e.Torso.Events=t(e._,e.Backbone))}(this,function(e,t){"use strict";var i=e.extend({},t.Events);return i}),function(e,t){"function"==typeof define&&define.amd?define(["backbone"],t):"object"==typeof exports?module.exports=t(require("backbone")):(e.Torso=e.Torso||{},e.Torso.Router=t(e.Backbone))}(this,function(e){"use strict";return e.Router.extend({})}),function(e,t){"function"==typeof define&&define.amd?define(["backbone","jquery"],t):"object"==typeof exports?module.exports=t(require("backbone"),require("jquery")):t(e.Backbone,e.$)}(this,function(e,t){"use strict";return e.$=t,!0}),function(e,t){"function"==typeof define&&define.amd?define(["underscore"],t):"object"==typeof exports?module.exports=t(require("underscore")):(e.Torso=e.Torso||{},e.Torso.Utils=e.Torso.Utils||{},e.Torso.Utils.handlebarsUtils=t(e._))}(this,function(e){"use strict";return function(t){var i="feedback",n="model";t.registerHelper("labelFor",function(i,n){return n=e.extend(n,{noValueAttr:!0}),t.helpers.formAttr(i,"for",n)}),t.registerHelper("bindModel",function(e,s){return t.helpers.formAttr(e,n+", "+i+", name, id",s)}),t.registerHelper("feedback",function(n,s){return s=e.extend(s,{noValueAttr:!0}),t.helpers.formAttr(n,i,s)}),t.registerHelper("formAttr",function(e,s,r){var o,a,d=r.hash?r.hash.value:void 0,c=t.helpers.injectFieldIndices(e,r.hash),h=t.helpers.injectFieldIndices(e,r.hash,{forceArrayNotation:!0}),u="";for(s=s.split(","),o=0;o<s.length;o++){a=s[o].trim();var l=o===s.length-1?'"':'" ';a===i?u+='data-feedback="'+h+l:a===n?u+='data-model="'+c+l:"name"===a?u+='name="'+t.helpers.dasherize(c)+l:"id"===a?(u+='id="'+t.helpers.dasherize(c),void 0!==d&&(u+="-"+d),u+=l):"for"===a&&(u+='for="'+t.helpers.dasherize(c),void 0!==d&&(u+="-"+d),u+=l)}return void 0===d||r.noValueAttr||(u+=' value="'+d+'"'),new t.SafeString(u)}),t.registerHelper("dasherize",function(e){var t,i,n;return t=e.replace(/([A-Z])/g,function(e){return"-"+e.toLowerCase()}),i=t.replace(/\./g,function(){return"_"}),n=i.replace(/\[[0-9]+\]/g,function(e){return"-"+e.substring(1,e.length-1)})}),t.registerHelper("injectFieldIndices",function(t,i,n){return i?t.replace(/\[.+?\]/g,function(t){var s=i[t.substring(1,t.length-1)],r="["+(void 0===s?"":s)+"]",o=n&&n.forceArrayNotation;return e.isString(s)&&!o&&(r="."+s),r}):t})}}),function(e,t){"function"==typeof define&&define.amd?define(["backbone"],t):"object"==typeof exports?module.exports=t(require("backbone")):(e.Torso=e.Torso||{},e.Torso.history=t(e.Backbone))}(this,function(e){"use strict";return e.history}),function(e,t){"function"==typeof define&&define.amd?define(["backbone","backbone.stickit"],t):"object"==typeof exports?(require("backbone.stickit"),t(require("backbone"))):t(e.Backbone)}(this,function(e){"use strict";e.Stickit.addHandler({selector:'input[type="radio"]',events:["change"],update:function(e,t){e.prop("checked",!1),e.filter('[value="'+t+'"]').prop("checked",!0)},getVal:function(e){return e.filter(":checked").val()}})}),function(e,t){"function"==typeof define&&define.amd?define(["underscore","backbone"],t):"object"==typeof exports?module.exports=t(require("underscore"),require("backbone")):(e.Torso=e.Torso||{},e.Torso.Utils=e.Torso.Utils||{},e.Torso.Utils.templateRenderer=t(e._,e.Backbone))}(this,function(e,t){"use strict";function i(e,t,i){var n,s=t.nodeType,r=e.nodeType;s!==r?o(e).replaceWith(t):(n=a[s]||a["default"])(e,t,i)}function n(e){var t=o(e),i=t.data("stickit-bind-val");"OPTION"===e.tagName&&void 0!==e.value&&i!==e.value&&t.removeData("stickit-bind-val")}function s(t,s,r){var a,d,c,h,u,l=o(t),f=o(s),p=0;if(d=e.some(r,function(e){return l.is(e)}),!d){if(s.tagName!==t.tagName)return void l.replaceWith(s);u=t.attributes;for(var _=u.length;p<u.length;)if(a=u[p].name,s.getAttribute(a))p++;else{if(t.removeAttribute(a),_===u.length)return void l.replaceWith(s);_=u.length}if(e.each(s.attributes,function(e){t.setAttribute(e.name,e.value)}),n(t),l.html()!==f.html())return h=f.contents(),c=l.contents(),h.length!==c.length?void l.html(f.html()):void c.each(function(e,t){i(t,h.get(e),r)})}}function r(e,t){var i=t.nodeValue!==e.nodeValue;i&&o(e).replaceWith(t)}var o=t.$,a={1:s,3:r,4:r,8:r,"default":function(e,t){o(e).replaceWith(t)}},d={render:function(e,t,i,n){var s,r,a=e.get(0);n=n||{},r=n.newHTML||t(i),n.force?e.html(r):(s=this.copyTopElement(a),o(s).html(r),this.hotswapKeepCaret(a,s,n.ignoreElements))},hotswapKeepCaret:function(e,t,i){var n,s,r=!1;try{s=document.activeElement}catch(a){s=null}s&&e&&o.contains(s,e)&&(r=!0),r&&this.supportsSelection(s)&&(n=this.getCaretPosition(s)),this.hotswap(e,t,i),r&&this.supportsSelection(s)&&this.setCaretPosition(s,n)},hotswap:i,copyTopElement:function(t){var i=document.createElement(t.tagName);return e.each(t.attributes,function(e){i.setAttribute(e.name,e.value)}),i},supportsSelection:function(e){return/text|password|search|tel|url/.test(e.type)},getCaretPosition:function(e){var t,i=0;return document.selection?(e.focus(),t=document.selection.createRange(),t.moveStart("character",-e.value.length),i=t.text.length):(e.selectionStart||0===e.selectionStart)&&(i=e.selectionStart),i},setCaretPosition:function(e,t){var i;e&&(e.createTextRange?(i=e.createTextRange(),i.move("character",t),i.select()):e.selectionStart||0===e.selectionStart?(e.focus(),e.setSelectionRange(t,t)):e.focus())}};return d}),function(e,t){"function"==typeof define&&define.amd?define(["underscore","backbone"],t):"object"==typeof exports?module.exports=t(require("underscore"),require("backbone")):(e.Torso=e.Torso||{},e.Torso.Mixins=e.Torso.Mixins||{},e.Torso.Mixins.cache=t(e._,e.Backbone))}(this,function(e,t){var i=t.$,n=function(t){var n,s;return s=function(t,n){return t.constructor.extend(function(t,n,s){var r={getTrackedIds:function(){return this.trackedIds},fetch:function(e){return e=e||{},e.idsToFetch=e.idsToFetch||this.trackedIds,e.setOptions=e.setOptions||{remove:!1},this.__loadWrapper(function(){return e.idsToFetch&&e.idsToFetch.length?n.fetchByIds(e):i.Deferred().resolve().promise()})},fetchByIds:function(t,i){return i=i||{},i.idsToFetch=e.intersection(t,this.getTrackedIds()),this.fetch(i)},trackIds:function(t){this.remove(e.difference(this.trackedIds,t)),n.registerIds(t,s),this.trackedIds=t},addModelAndTrack:function(e){this.add(e),n.add(e),this.trackNewId(e.id)},trackNewId:function(e){this.trackIds(this.getTrackedIds().concat(e))},trackAndFetch:function(e){return this.trackIds(e),this.fetch()},pull:function(t){t=t||{};var s=e.difference(this.getTrackedIds(),e.pluck(n.models,"id")),r=e.pick(n.idPromises,s);t.idsToFetch=e.difference(s,e.uniq(e.flatten(e.keys(r))));var o=this.fetch(t),a=e.flatten(e.values(r));a.push(o);var d=e.uniq(a);return i.when.apply(i,d).then(function(){var t=e.zip(arguments),i=t[0],n=e.flatten(i);return n})},trackAndPull:function(e){return this.trackIds(e),this.pull()},requesterDispose:function(){n.removeRequester(s)},remove:function(i){var n=this.get(i);if(t.remove.apply(this,arguments),n){var s=this.getTrackedIds();s=e.without(s,n.id),this.trackIds(s)}}};return r}(t.constructor.__super__,t,n))},n=function(n){var r=function(t,i){n.requestMap[t]={array:i,dict:e.object(e.map(i,function(e){return[e,e]}))}};n.getRequesterIds=function(e){return this.requestMap[e]&&this.requestMap[e].array},n.getRequesterIdsAsDictionary=function(e){return this.requestMap[e]&&this.requestMap[e].dict},n.removeRequester=function(e){delete this.requestMap[e],delete this.knownPrivateCollections[e]},n.getRequesters=function(){return e.keys(this.requestMap)},n.getAllRequestedIds=function(){return this.collectionTrackedIds},n.createPrivateCollection=function(e,t){t=t||{},t.isRequester=!0,t.parentInstance=n;var i=s(n,e);return this.knownPrivateCollections[e]=new i(null,t),this.knownPrivateCollections[e]},n.registerIds=function(t,i){var s,o,a,d,c,h,u,l,f=[],p={},_=[];for(r(i,t),h=n.getRequesters(),u=h.length,o=0;o<t.length;o++)a=n.get(t[o]),a&&f.push(a);for(l=n.knownPrivateCollections[i],l&&l.set(f,{remove:!1}),d=0;d<u;d++)if(c=this.getRequesterIds(h[d]),!e.isUndefined(c))for(s=0;s<c.length;s++)p[c[s]]=!0;for(s in p)_.push(s);this.collectionTrackedIds=_,this.polledFetch=function(){n.fetchByIds({setOptions:{remove:!0}})}},n.fetch=function(i){return i=i||{},this.fetchUsingTrackedIds?this.fetchByIds({setOptions:e.extend({remove:!0},i)}):t.prototype.fetch.call(this,i)},n.fetchByIds=function(t){t=t||{};var s=t.idsToFetch||n.collectionTrackedIds,r=!1,o=this.__loadWrapper(function(t){var r=t.fetchContentType||n.fetchContentType,o={type:n.fetchHttpAction,url:e.result(n,"url")+n.getByIdsUrl,data:{ids:s.join(",")}};return(r||o.type&&"GET"!=o.type.toUpperCase())&&(o.contentType=r||"application/json; charset=utf-8",o.data=JSON.stringify(s)),i.ajax(o).done(function(e){var i,r,o,a,d,c,h,u,l=s.length,f=t.setOptions;for(n.set(n.parse(e),f),h=n.getRequesters(),c=h.length,r=0;r<c;r++){for(o=n.getRequesterIdsAsDictionary(h[r]),a=[],i=0;i<l;i++)o[s[i]]&&(u=n.get(s[i]),u&&a.push(u));d=n.knownPrivateCollections[h[r]],d&&d.set(a,{remove:!1})}})},t).always(function(){r=!0,e.each(s,function(t){if(n.idPromises){var i=n.idPromises[t],s=e.without(i,o);e.isEmpty(s)?delete n.idPromises[t]:n.idPromises[t]=s}})});return r||e.each(s,function(e){var t=n.idPromises[e];t||(t=[],n.idPromises[e]=t),t.push(o)}),o}},{constructor:function(i,s){if(s=s||{},t.call(this,i,s),this.isRequester=s.isRequester,this.parentInstance=s.parentInstance,this.isRequester)this.trackedIds=[],this.listenTo(this.parentInstance,"load-begin",function(){this.trigger("cache-load-begin")}),this.listenTo(this.parentInstance,"load-complete",function(){this.trigger("cache-load-complete")});else{this.requestMap={},this.collectionTrackedIds=[],this.knownPrivateCollections={},this.idPromises={};var r=e.defaults(e.pick(s,"getByIdsUrl","fetchHttpAction","fetchUsingTrackedIds"),e.pick(this,"getByIdsUrl","fetchHttpAction","fetchUsingTrackedIds"),{getByIdsUrl:"/ids",fetchHttpAction:"GET",fetchUsingTrackedIds:!0});e.extend(this,r),n(this)}}}};return n}),function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():(e.Torso=e.Torso||{},e.Torso.Mixins=e.Torso.Mixins||{},e.Torso.Mixins.cell=t())}(this,function(){"use strict";return{isModelCompatible:!1,save:function(){if(!this.isModelCompatible)throw"Cell does not have save"},fetch:function(){if(!this.isModelCompatible)throw"Cell does not have fetch"},sync:function(){if(!this.isModelCompatible)throw"Cell does not have sync"},url:function(){if(!this.isModelCompatible)throw"Cell does not have url"}}}),function(e,t){"function"==typeof define&&define.amd?define(["backbone"],t):"object"==typeof exports?module.exports=t(require("backbone")):(e.Torso=e.Torso||{},e.Torso.Mixins=e.Torso.Mixins||{},e.Torso.Mixins.loading=t(e.Backbone))}(this,function(e){var t=e.$,i=function(e){return{constructor:function(i){e.call(this,i),this.loadedOnceDeferred=new t.Deferred,this.loadedOnce=!1,this.loadingCount=0,this.loading=!1},hasLoadedOnce:function(){return this.loadedOnce},isLoading:function(){return this.loading},getLoadedOncePromise:function(){return this.loadedOnceDeferred.promise()},fetch:function(t){return this.__loadWrapper(e.prototype.fetch,t)},__loadWrapper:function(e,i){var n=this;return this.loadingCount++,this.loading=!0,this.trigger("load-begin"),t.when(e.call(n,i)).always(function(){n.loadedOnce||(n.loadedOnce=!0,n.loadedOnceDeferred.resolve()),n.loadingCount--,n.loadingCount<=0&&(n.loadingCount=0,n.loading=!1)}).done(function(e,t,i){n.trigger("load-complete",{success:!0,data:e,textStatus:t,jqXHR:i})}).fail(function(e,t,i){n.trigger("load-complete",{success:!1,jqXHR:e,textStatus:t,errorThrown:i})})}}};return i}),function(e,t){"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?module.exports=t():(e.Torso=e.Torso||{},e.Torso.Mixins=e.Torso.Mixins||{},e.Torso.Mixins.polling=t())}(this,function(){var e={pollTimeoutId:void 0,__pollStarted:!1,__pollInterval:5e3,isPolling:function(){return this.__pollStarted},startPolling:function(e){var t=this;e&&(this.__pollInterval=e),this.__pollStarted||(this.__pollStarted=!0,this.pollTimeoutId=window.setInterval(function(){t.__poll()},this.__pollInterval),this.__poll())},stopPolling:function(){window.clearInterval(this.pollTimeoutId),this.__pollStarted=!1},polledFetch:function(){this.fetch()},__poll:function(){this.polledFetch()}};return e}),function(e,t){"function"==typeof define&&define.amd?define(["underscore","backbone","./mixins/cellMixin"],t):"object"==typeof exports?module.exports=t(require("underscore"),require("backbone"),require("./mixins/cellMixin")):(e.Torso=e.Torso||{},e.Torso.Cell=t(e._,e.Backbone,e.Torso.Mixins.cell))}(this,function(e,t,i){"use strict";var n=t.Model.extend({});return e.extend(n.prototype,i),n}),function(e,t){"function"==typeof define&&define.amd?define(["underscore","backbone","./mixins/pollingMixin","./mixins/cacheMixin","./mixins/loadingMixin"],t):"object"==typeof exports?module.exports=t(require("underscore"),require("backbone"),require("./mixins/pollingMixin"),require("./mixins/cacheMixin"),require("./mixins/loadingMixin")):(e.Torso=e.Torso||{},e.Torso.Collection=t(e._,e.Backbone,e.Torso.Mixins.polling,e.Torso.Mixins.cache,e.Torso.Mixins.loading))}(this,function(e,t,i,n,s){"use strict";var r=t.Collection.extend({filterDefault:function(){return this.constructor(this)},dispose:function(){this.unbind(),this.off(),this.stopListening(),this.stopPolling(),this.isRequester&&this.requesterDispose()}});return e.extend(r.prototype,i),r=r.extend(s(r)),r=r.extend(n(r))}),function(e,t){"function"==typeof define&&define.amd?define(["underscore","backbone","./mixins/pollingMixin"],t):"object"==typeof exports?module.exports=t(require("underscore"),require("backbone"),require("./mixins/pollingMixin")):(e.Torso=e.Torso||{},e.Torso.Model=t(e._,e.Backbone,e.Torso.Mixins.polling))}(this,function(e,t,i){"use strict";var n=t.Model.extend({});return e.extend(n.prototype,i),n}),function(e,t){"function"==typeof define&&define.amd?define(["underscore","backbone","./mixins/cellMixin","backbone-nested"],t):"object"==typeof exports?(require("backbone-nested"),module.exports=t(require("underscore"),require("backbone"),require("./mixins/cellMixin"))):(e.Torso=e.Torso||{},e.Torso.NestedCell=t(e._,e.Backbone,e.Torso.Mixins.cell))}(this,function(e,t,i){"use strict";var n=t.NestedModel.extend({});return e.extend(n.prototype,i),n}),function(e,t){"function"==typeof define&&define.amd?define(["underscore","backbone","./mixins/pollingMixin","backbone-nested"],t):"object"==typeof exports?(require("backbone-nested"),module.exports=t(require("underscore"),require("backbone"),require("./mixins/pollingMixin"))):(e.Torso=e.Torso||{},e.Torso.NestedModel=t(e._,e.Backbone,e.Torso.Mixins.polling))}(this,function(e,t,i){"use strict";var n=t.NestedModel.extend({});return e.extend(n.prototype,i),n}),function(e,t){if("function"==typeof define&&define.amd)define(["underscore","./NestedCell"],t);else if("object"==typeof exports){var i=require("underscore"),n=require("./NestedCell");module.exports=t(i,n)}else e.Torso=e.Torso||{},e.Torso.Behavior=t(e._,e.Torso.NestedCell)}(this,function(e,t){"use strict";var i={"before-attached-callback":"_attached","before-detached-callback":"_detached","before-activate-callback":"_activate","before-deactivate-callback":"_deactivate","before-dispose-callback":"_dispose","render:before-attach-tracked-views":"attachTrackedViews","render:begin":"prerender","render:complete":"postrender","initialize:begin":"preinitialize","initialize:complete":"postinitialize"},n=t.extend({cidPrefix:"b",mixin:{},prepare:e.noop,constructor:function(i,n,s){if(n=n||{},!n.view)throw new Error("Torso Behavior constructed without behaviorOptions.view");if(this.view=n.view,!n.alias)throw new Error("Torso Behavior constructed without behaviorOptions.alias");this.alias=n.alias,this.cid=this.cid||e.uniqueId(this.cidPrefix),this.__bindLifecycleMethods(),t.apply(this,arguments),this.__bindEventCallbacks()},__augmentViewPrepare:function(){var t=e.bind(this.view.prepare,this.view),i=e.wrap(t,this.__viewPrepareWrapper);this.view.prepare=e.bind(i,this)},__viewPrepareWrapper:function(t){var i=t()||{},n=e.omit(this.toJSON(),"view");return e.extend(n,this.prepare()),i[this.alias]=n,i},__bindLifecycleMethods:function(){this.listenTo(this.view,"initialize:complete",this.__augmentViewPrepare),this.listenTo(this.view,"before-dispose-callback",this.__dispose),e.each(i,function(e,t){this.listenTo(this.view,t,this[e])},this)},__bindEventCallbacks:function(){var t=e.result(this,"events"),i=this.view.events;if(!i){if(!t)return;i={}}var n=this.__namespaceEvents(t),s=this.__bindEventCallbacksToBehavior(n);e.isFunction(i)?this.view.events=e.wrap(e.bind(i,this.view),function(t){return e.extend(s,t())}):e.isObject(i)&&(this.view.events=e.extend(s,i))},__namespaceEvents:function(t){var i=/^(\S+)\s*(.*)$/,n={},s=this.cid;return e.each(t,function(e,t){var r=t.match(i),o=r[1],a=r[2],d=o+".behavior."+s;n[[d,a].join(" ")]=e}),n},__bindEventCallbacksToBehavior:function(t){return e.mapObject(t,function(t){return e.isFunction(t)||(t=this[t]),e.bind(t,this)},this)},__dispose:function(){this.trigger("before-dispose-callback"),this.stopListening(),this.off(),this.__isDisposed=!0},_dispose:e.noop,isDisposed:function(){return this.__isDisposed}});return n}),function(e,t){"function"==typeof define&&define.amd?define(["./Cell"],t):"object"==typeof exports?module.exports=t(require("./Cell")):(e.Torso=e.Torso||{},e.Torso.ServiceCell=t(e.Torso.Cell))}(this,function(e){"use strict";var t=e.extend({});return t}),function(e,t){"function"==typeof define&&define.amd?define(["underscore","backbone","./templateRenderer","./Cell","./NestedCell"],t):"object"==typeof exports?module.exports=t(require("underscore"),require("backbone"),require("./templateRenderer"),require("./Cell"),require("./NestedCell")):(e.Torso=e.Torso||{},e.Torso.View=t(e._,e.Backbone,e.Torso.Utils.templateRenderer,e.Torso.Cell,e.Torso.NestedCell))}(this,function(e,t,i,n,s){"use strict";var r=t.$,o=s.extend({initialize:function(e,t){t=t||{},this.view=t.view},trigger:function(e){"change"!==e&&0!==e.indexOf("change:")||a.prototype.trigger.apply(this.view,arguments),0===e.indexOf("change:hide:")&&this.view.render(),s.prototype.trigger.apply(this,arguments)}}),a=t.View.extend({viewState:null,template:void 0,feedback:null,feedbackCell:null,behaviors:null,templateRendererOptions:void 0,prepareFields:null,injectionSites:null,__behaviorInstances:null,__childViews:null,__sharedViews:null,__isActive:!1,__isAttachedToParent:!1,__isDisposed:!1,__attachedCallbackInvoked:!1,__feedbackOnEvents:null,__feedbackListenToEvents:null,constructor:function(e){e=e||{},this.viewState=new o({},{view:this}),this.feedbackCell=new n,this.__childViews={},this.__sharedViews={},this.__injectionSiteMap={},this.__feedbackOnEvents=[],this.__feedbackListenToEvents=[],this.template=e.template||this.template,this.templateRendererOptions=e.templateRendererOptions||this.templateRendererOptions,this.__initializeBehaviors(e),this.trigger("initialize:begin"),t.View.apply(this,arguments),this.trigger("initialize:complete"),e.noActivate||this.activate()},get:function(){return this.viewState.get.apply(this.viewState,arguments)},set:function(){return this.viewState.set.apply(this.viewState,arguments)},has:function(){return this.viewState.has.apply(this.viewState,arguments)},unset:function(){return this.viewState.unset.apply(this.viewState,arguments)},toJSON:function(){return this.viewState.toJSON()},getBehavior:function(e){if(this.__behaviorInstances)return this.__behaviorInstances[e]},prepare:function(){return this.__getPrepareFieldsContext()},_prepare:function(e){},render:function(){if(this.isDisposed())throw new Error("Render called on a view that has already been disposed.");var t=this;if(this.trigger("render:begin"),this.prerender()===!1)return this.trigger("render:aborted"),r.Deferred().resolve().promise();this.__updateInjectionSiteMap(),this.trigger("render:before-dom-update"),this.detachTrackedViews(),this.updateDOM(),this.__pendingAttachInfo&&this.__performPendingAttach(),this.trigger("render:after-dom-update"),this.delegateEvents(),this.trigger("render:after-delegate-events"),this.unregisterTrackedViews({shared:!0}),this.trigger("render:before-attach-tracked-views"),this.__attachViewsFromInjectionSites();var i=this.attachTrackedViews();return r.when.apply(r,e.flatten([i])).done(function(){t.postrender(),t.trigger("render:complete"),t.__injectionSiteMap={},t.__lastTrackedViews={}})},prerender:e.noop,updateDOM:function(){if(this.template){var t=e.result(this,"templateRendererOptions");this.templateRender(this.$el,this.template,this.prepare(),t)}},postrender:e.noop,templateRender:function(t,n,s,r){r=r||{},e.isString(n)&&(r.newHTML=n),i.render(t,n,s,r)},delegateEvents:function(){this.undelegateEvents(),t.View.prototype.delegateEvents.call(this),this.__generateFeedbackBindings(),this.__generateFeedbackCellCallbacks(),e.each(this.getTrackedViews(),function(e){e.isAttachedToParent()&&e.delegateEvents()})},undelegateEvents:function(){t.View.prototype.undelegateEvents.call(this),e.each(this.getTrackedViews(),function(e){e.undelegateEvents()})},attachTo:function(e,t){t=t||{};var i=this;return this.isAttachedToParent()?r.Deferred().resolve().promise():(this.__pendingAttachInfo={$el:e,options:t},this.render().done(function(){!i.__attachedCallbackInvoked&&i.isAttached()&&i.__invokeAttached(),i.__isAttachedToParent=!0}))},attachView:function(t,i,n){n=n||{};var s,o,a=e.isString(t);if(a){if(o=t,s=this.$("[inject="+o+"]"),!s)throw"View.attachView: No injection site found with which to attach this view. View.cid="+this.cid}else s=t;return n.useTransition?this.__transitionNewViewIntoSite(o,i,n):(i.detach(),this.registerTrackedView(i,n),i.attachTo(s,n),n.noActivate||i.activate(),r.Deferred().resolve().promise())},attachTrackedViews:e.noop,_attached:e.noop,isAttachedToParent:function(){return this.__isAttachedToParent},isAttached:function(){return r.contains(document,this.$el[0])},detach:function(){var e;this.isAttachedToParent()&&(e=this.isAttached(),this.trigger("before-dom-detach"),this.injectionSite?(this.$el.replaceWith(this.injectionSite),this.injectionSite=void 0):this.$el.detach(),e&&this.__invokeDetached(),this.undelegateEvents(),this.__isAttachedToParent=!1)},detachTrackedViews:function(t){var i=this.getTrackedViews(t);e.each(i,function(e){e.detach()})},_detached:e.noop,activate:function(){this.__activateTrackedViews(),this.isActive()||(this.trigger("before-activate-callback"),this._activate(),this.__isActive=!0)},_activate:e.noop,isActive:function(){return this.__isActive},deactivate:function(){this.__deactivateTrackedViews(),this.isActive()&&(this.trigger("before-deactivate-callback"),this._deactivate(),this.__isActive=!1)},_deactivate:e.noop,dispose:function(){this.trigger("before-dispose-callback"),this._dispose(),this.detach(),this.deactivate(),this.__disposeChildViews(),this.remove(),this.off(),this.stopListening(),this.viewState&&(this.viewState.off(),this.viewState.stopListening()),this.feedbackCell&&(this.feedbackCell.off(),this.feedbackCell.stopListening()),delete this.$el,delete this.el,this.__isDisposed=!0},_dispose:e.noop,isDisposed:function(){return this.__isDisposed},hasTrackedViews:function(t){return!e.isEmpty(this.getTrackedViews(t))},getTrackedViews:function(t){return e.values(this.__getTrackedViewsHash(t))},getTrackedView:function(e){var t=this.__childViews[e],i=this.__sharedViews[e];return t||i},registerTrackedView:function(e,t){return t=t||{},this.unregisterTrackedView(e),t.child||!t.shared?this.__childViews[e.cid]=e:this.__sharedViews[e.cid]=e,e},unregisterTrackedView:function(e){return delete this.__childViews[e.cid],delete this.__sharedViews[e.cid],e},unregisterTrackedViews:function(t){var i=this.getTrackedViews(t);e.each(i,function(e){this.unregisterTrackedView(e,t)},this)},transitionOut:function(e,t){this.detach(),e()},transitionIn:function(e,t,i){e(),t()},invokeFeedback:function(t,i,n){var s,r=e.find(this.feedback,function(i){var n=i.to;return e.isArray(n)?e.contains(n,t):t===n}),o=t;r&&(n&&(o=this.__substituteIndicesUsingMap(t,n)),s=r.then.call(this,i,n),this.__processFeedbackThenResult(s,o))},__attachViewsFromInjectionSites:function(){var i=e.result(this,"injectionSites");e.each(i,function(i,n){if(!this.get("hide:"+n)){var s,r={};e.isFunction(i)&&(i=i.call(this)),i instanceof t.View?s=i:e.isObject(i)&&(r=i.options,i=i.view),s||(e.isString(i)?s=e.result(this,i):i instanceof t.View?s=i:e.isFunction(i)&&(s=i.call(this))),s&&this.attachView(n,s,r)}},this)},__getPrepareFieldsContext:function(){var t={},i=e.result(this,"prepareFields");if(i&&e.isObject(i)&&!e.isArray(i)){var n=e.keys(i);i=e.map(n,function(e){return{name:e,value:i[e]}})}var s=[{name:"view",value:"viewState"},"model"];if(i=e.union(i,s),i&&i.length>0)for(var r=0;r<i.length;r++){var o=i[r],a=e.isString(o),d=o,c=o;if(!a){if(!e.isString(o.name))throw"prepareFields items need to either be a string or define a .name property that is a simple string to use for the key in the template context.";if(e.isUndefined(o.value))throw"prepareFields items need a value property if it is not a string.";d=o.name,c=o.value}if(!e.isUndefined(t[d]))throw"duplicate prepareFields name ("+d+").  Note 'view' and 'model' are reserved names.";var h=!1;if(e.isFunction(c))c=c.call(this);else{var u=e.result(this,c);h=!e.isUndefined(u),h&&(c=u)}c&&e.isFunction(c.toJSON)?t[d]=c.toJSON():a&&!h||(t[d]=c)}var l=this._prepare(t);return l=e.isUndefined(l)?t:e.extend(t,l)},__initializeBehaviors:function(t){var i=this;e.isEmpty(this.behaviors)||(i.__behaviorInstances={},e.each(this.behaviors,function(n,s){e.has(n,"behavior")||(n={behavior:n});var r=n.behavior;if(!r||!e.isFunction(r))throw new Error('Incorrect behavior definition. Expected key "behavior" to be a class but instead got '+String(r));var o=e.pick(n,function(e,t){return"behavior"!==t});o.view=i,o.alias=s;var a=n.attributes||{},d=i.__behaviorInstances[s]=new r(a,o,t);if(d.mixin){var c=e.result(d,"mixin");e.each(c,function(t,n){e.isUndefined(i[n])&&(e.isFunction(t)?i[n]=e.bind(t,d):i[n]=t)})}}))},__performPendingAttach:function(){this.trigger("before-dom-attach"),this.__replaceInjectionSite(this.__pendingAttachInfo.$el,this.__pendingAttachInfo.options),delete this.__pendingAttachInfo},__deactivateTrackedViews:function(t){e.each(this.getTrackedViews(t),function(e){e.deactivate()})},__activateTrackedViews:function(t){e.each(this.getTrackedViews(t),function(e){e.activate()})},__disposeChildViews:function(){e.each(this.__childViews,function(e){e.dispose()})},__transitionNewViewIntoSite:function(t,i,n){var s,r;return n=n||{},s=n.previousView,s||(s=this.__injectionSiteMap[t]),e.defaults(n,{parentView:this,newView:i,previousView:s}),n.useTransition=!1,s==i?this.attachView(t,i,n):s?this.__performTwoWayTransition(t,s,i,n):(r=this.$("[inject="+t+"]"),this.__transitionInView(r,i,n))},__performTwoWayTransition:function(e,t,i,n){var s,o,a=r.Deferred();return this.attachView(e,t,n),n.cachedInjectionSite=t.injectionSite,s=n.newInjectionSite=r('<span inject="'+e+'">'),n.addBefore?t.$el.before(s):t.$el.after(s),t.injectionSite=void 0,t.transitionOut(a.resolve,n),o=this.__transitionInView(s,i,n),r.when(a.promise(),o)},__transitionInView:function(t,i,n){var s=r.Deferred(),o=this;return n=e.extend({},n),e.defaults(n,{parentView:this,newView:i}),i.transitionIn(function(){o.attachView(t,i,n)},s.resolve,n),s.promise()},__getTrackedViewsHash:function(t){var i={};return t=t||{},t.shared&&(i=e.extend(i,this.__sharedViews)),t.child&&(i=e.extend(i,this.__childViews)),t.child||t.shared||(i=e.extend(i,this.__sharedViews,this.__childViews)),i},__updateInjectionSiteMap:function(){var t=this;this.__injectionSiteMap={},this.__lastTrackedViews={},e.each(this.getTrackedViews(),function(e){e.isAttachedToParent()&&e.injectionSite&&(t.__injectionSiteMap[e.injectionSite.attr("inject")]=e),t.__lastTrackedViews[e.cid]=e})},__replaceInjectionSite:function(e,t){t=t||{},this.injectionSite=t.replaceMethod?t.replaceMethod(this.$el):e.replaceWith(this.$el),t.discardInjectionSite&&(this.injectionSite=void 0)},__invokeAttached:function(){this.__attachedCallbackInvoked||(this.trigger("before-attached-callback"),this._attached(),this.__attachedCallbackInvoked=!0,e.each(this.getTrackedViews(),function(e){e.isAttachedToParent()&&e.__invokeAttached()}))},__invokeDetached:function(){this.__attachedCallbackInvoked&&(this.trigger("before-detached-callback"),this._detached(),this.__attachedCallbackInvoked=!1),e.each(this.getTrackedViews(),function(e){e.isAttachedToParent()&&e.__invokeDetached()})},__generateFeedbackCellCallbacks:function(){var t=this;t.feedbackCell.off(),e.each(this.$("[data-feedback]"),function(i){var n=r(i).data("feedback");t.feedbackCell.on("change:"+n,function(i){return function(){var n,s=t.feedbackCell.get(i);s&&(n=t.$el.find('[data-feedback="'+i+'"]'),e.each(s,function(i,s){var r;r="_"===e.first(s)?t[s.slice(1)]:n[s],e.isArray(i)?r.apply(n,i):void 0!==i&&r.call(n,i)}))}}(n))}),e.each(t.feedbackCell.attributes,function(e,i){t.feedbackCell.trigger("change:"+i)})},__processFeedbackThenResult:function(e,t){var i=r.extend({},e);this.feedbackCell.set(t,i,{silent:!0}),this.feedbackCell.trigger("change:"+t)},__generateFeedbackBindings:function(){var t,i=this;for(t=0;t<this.__feedbackOnEvents.length;t++)this.off(null,this.__feedbackOnEvents[t]);for(t=0;t<this.__feedbackListenToEvents.length;t++){var n=this.__feedbackListenToEvents[t];this.stopListening(n.obj,n.name,n.callback)}this.__feedbackOnEvents=[],this.__feedbackListenToEvents=[],e.each(this.feedback,function(t){var n=[t.to];e.isArray(t.to)&&(n=t.to),e.each(n,function(n){var s=i.__getFeedbackDestinations(n),o=i.__getAllIndexTokens(n);e.each(s,function(n){var s,a,d,c,h,u,l,f;n=r(n),s=n.data("feedback"),a=i.__getAllIndexTokens(s),d={},e.each(o,function(e,t){d[e]=a[t]}),c=t.then,e.isString(c)?c=i[c]:e.isArray(c)&&(h=c.slice(),u=h[0],h.shift(),c=i[u].apply(i,h)),f={feedbackCellField:s,fn:c,indices:d},l=i.__generateWhenEvents(t.when,d),e.each(l,function(t){var n,s,r=function(e){var t,n,s;t=[e],s={},t.push(f.indices),n=f.fn.apply(i,t),i.__processFeedbackThenResult(n,f.feedbackCellField)};s=/^(\S+)\s*(.*)$/,n=t.match(s),i.$el.on(n[1]+".delegateEvents"+i.cid,n[2],e.bind(r,i))}),e.each(t.when.on,function(e){var t=i.__generateThenCallback(f,e);i.on(e,t,i),i.__feedbackOnEvents.push(t)}),e.each(t.when.listenTo,function(t){var n=t.object;if(e.isFunction(n)?n=e.bind(t.object,i)():e.isString(n)&&(n=e.result(i,t.object)),n){var s=e.bind(i.__generateThenCallback(f,t.events),i);i.listenTo(n,t.events,s),i.__feedbackListenToEvents.push({object:n,name:t.events,callback:s})}})})})})},__generateThenCallback:function(e,t){return function(){var i,n=[{args:arguments,type:t}];n.push(e.indices),i=e.fn.apply(this,n),this.__processFeedbackThenResult(i,e.feedbackCellField)}},__getFeedbackDestinations:function(e){var t=this,i=this.__stripAllAttribute(e),n=e,s=e.indexOf("[");return s>0&&(n=e.substring(0,s)),this.$('[data-feedback^="'+n+'"]').filter(function(){return t.__stripAllAttribute(r(this).data("feedback"))===i})},__generateWhenEvents:function(t,i){var n=this,s=[];return e.each(t,function(t,r){var o,a=[r],d="@"===r.charAt(0);"on"===r&&"listenTo"===r||(d&&(r=r.substring(1),o=n.__substituteIndicesUsingMap(r,i),a=e.flatten(n.__generateSubAttributes(o,n.model))),e.each(a,function(i){e.each(t,function(e){var t=e+" "+i;d&&(t=e+' [data-model="'+i+'"]'),s.push(t)})}))}),s},__getAllIndexTokens:function(t){return e.reduce(t.match(/\[.+?\]/g),function(e,t){var i=t.substring(1,t.length-1);return isNaN(i)?e.push(i):e.push(parseInt(i,10)),e},[])},__stripAllAttribute:function(e){return e=e.replace(/\[.+?\]/g,function(){return"[]"})},__substituteIndicesUsingMap:function(t,i){var n;return t.replace(/\[[^\]]*\]/g,function(t){
return t.match(/\[\d+\]/g)||t.match(/\[\]/g)?t:(n=i[t.substring(1,t.length-1)],e.isString(n)?"."+n:"["+(void 0===n?"":n)+"]")})},__generateSubAttributes:function(t,i){var n=t.indexOf("[]");if(n===-1)return[t];var s=t.substring(0,n),r=t.substring(n+2),o=[],a=i.get(s);if(!a)return[t];var d;return d=e.isArray(a)?e.range(a.length):e.keys(a),e.each(d,function(t){var n="["+t+"]";e.isString(t)&&(n="."+t),o.push(this.__generateSubAttributes(s+n+r,i))},this),o}});return a}),function(e,t){"function"==typeof define&&define.amd?define(["underscore","./NestedModel"],t):"object"==typeof exports?module.exports=t(require("underscore"),require("./NestedModel")):(e.Torso=e.Torso||{},e.Torso.Mixins=e.Torso.Mixins||{},e.Torso.validation=t(e._,e.Torso.NestedModel),e.Torso.Mixins.validation=e.Torso.validation.mixin)}(this,function(e,t){"use strict";var i={forceUpdate:!1,selector:"name",labelFormatter:"sentenceCase",messageFormatter:"none",valid:Function.prototype,invalid:Function.prototype},n={formatLabel:function(e,t){return d[i.labelFormatter](e,t)},format:function(){return c[i.messageFormatter].apply(c,arguments)}},s=function(t,i,n){return i=i||{},n=n||"",e.each(t,function(e,r){t.hasOwnProperty(r)&&(e&&"object"==typeof e&&e.constructor===Object&&s(e,i,n+r+"."),i[n+r]=e)}),i},r=function(){var r=function(t,i){return i=i||e.keys(e.result(t,"validation")||{}),e.reduce(i,function(e,t){return e[t]=void 0,e},{})},o=function(t){var i=t.attributes;if(e.isFunction(i)&&(i=i()),e.isArray(i))return i},a=function(t,i){var n=t.validation?e.result(t,"validation")[i]||{}:{};return(e.isFunction(n)||e.isString(n))&&(n={fn:n}),e.isArray(n)||(n=[n]),e.reduce(n,function(t,i){return e.each(e.without(e.keys(i),"msg","msgKey"),function(e){t.push({fn:h[e],val:i[e],msg:i.msg,msgKey:i.msgKey})}),t},[])},d=function(e){var t,i,n=0,s=!0,r=[];for(t=e.indexOf("[",n);t>0&&s;)i=e.indexOf("]",n),r.push(parseInt(e.substring(t+1,i),10)),n=i+1,s=n>0,t=e.indexOf("[",n);return r},c=function(t,i,n){var s,r,o,a,d=t.indexOf("[]");if(e.isEmpty(n)&&(n=[]),d===-1)return{attr:t,index:n};s=t.substring(0,d),r=t.substring(d+2),o=[];var h=i.get(s);return e.each(h,function(e,t){a=n.slice(),a.push(t),o.push(c(s+"["+t+"]"+r,i,a))}),o},u=function(e){return t&&e instanceof t},l=function(e){return e.indexOf(".")>0||e.indexOf("]")>0},f=function(e){var t,i,n=0,s=!0;if(t=e.indexOf("[",n),t<0)return e;for(i=e.substring(0,t+1);t>0&&s;)n=e.indexOf("]",n)+1,s=n>0,t=e.indexOf("[",n),t>0&&(i+=e.substring(n-1,t+1));return i+=e.substring(n-1)},p=function(t,i,n,s,r,o){var a,d;return e.isArray(i)?e.reduce(i,function(e,i){return e.push(p(t,i,n,s,r,o+1)),e},[]):(d=i.index,a=i.attr,e.isUndefined(n)&&l(a)&&(n=t.get(a)),_(r,t,n,a,s,d))},_=function(t,i,s,r,o,a){return e.reduce(t,function(t,d){var c=e.extend({msgKey:d.msgKey},n,h),u=d.fn.call(c,s,r,d.val,i,o,a);return u!==!1&&t!==!1&&(u&&!t?e.result(e.extend({},d,n,h),"msg")||u:t)},"")},v=function(t,i,n,s){var r,o,d,h=a(t,i);return o=c(i,t),d=p(t,o,n,s,h,0),e.isArray(d)&&(r=e.reduce(e.flatten(d),function(e,t){return e||t},!1),!r)?"":d},g=function(t,i,n){var s,r={},o=!0,a=e.clone(i);return e.each(n,function(e,i){s=v(t,i,e,a),s&&(r[i]=s,o=!1)}),{invalidAttrs:r,isValid:o}},m=function(t,i,n){var s,r,o=t.validation?e.result(t,"validation")||{}:{};return e.contains(e.keys(o),n)?v(t,n,i,e.extend({},t.attributes)):(s=d(n),n=f(n),r=a(t,n),_(r,t,i,n,e.extend({},t.attributes),s))},b=function(t){return{preValidate:function(t,i){var n,s=this,r={};return e.isArray(t)?(e.each(t,function(e){n=s.preValidate(e),n&&(r[e]=n)}),e.isEmpty(r)?void 0:r):e.isObject(t)?(e.each(t,function(e,t){n=s.preValidate(t,e),n&&(r[t]=n)}),e.isEmpty(r)?void 0:r):(e.isUndefined(i)&&u(this)&&(i=this.get(t)),m(this,i,t))},isValid:function(i){var n,r,a;return i=i||o(t),e.isString(i)?n=[i]:e.isArray(i)&&(n=i),n&&e.each(n,function(e){var t;t=u(this)?this.get(e):s(this.attributes)[e],r=m(this,t,e),r&&(a=a||{},a[e]=r)},this),i===!0&&(a=this.validate()),a&&this.trigger("invalid",this,a,{validationError:a}),n?!a:!this.validation||this._isValid},validate:function(i,n){var a=this,d=e.extend({},t,n),c=r(a,o(t)),h=e.extend({},c,a.attributes,i),u=e.extend(s(h),i),l=i?s(i):u,f=g(a,h,e.pick(u,e.keys(c)));if(a._isValid=f.isValid,e.defer(function(){a.trigger("validated",a._isValid,a,f.invalidAttrs),a.trigger("validated:"+(a._isValid?"valid":"invalid"),a,f.invalidAttrs)}),!d.forceUpdate&&e.intersection(e.keys(f.invalidAttrs),e.keys(l)).length>0)return f.invalidAttrs}}};return{version:"0.11.3",configure:function(t){e.extend(i,t)},mixin:b(i)}}(),o=r.patterns={digits:/^\d+$/,number:/^-?(?:\d+|\d{1,3}(?:,\d{3})+)(?:\.\d+)?$/,email:/^((([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+(\.([a-z]|\d|[!#\$%&'\*\+\-\/=\?\^_`{\|}~]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])+)*)|((\x22)((((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(([\x01-\x08\x0b\x0c\x0e-\x1f\x7f]|\x21|[\x23-\x5b]|[\x5d-\x7e]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(\\([\x01-\x09\x0b\x0c\x0d-\x7f]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]))))*(((\x20|\x09)*(\x0d\x0a))?(\x20|\x09)+)?(\x22)))@((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))$/i,url:/^(https?|ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i},a=r.messages={required:"{0} is required",acceptance:"{0} must be accepted",min:"{0} must be greater than or equal to {1}",max:"{0} must be less than or equal to {1}",range:"{0} must be between {1} and {2}",length:"{0} must be {1} characters",minLength:"{0} must be at least {1} characters",maxLength:"{0} must be at most {1} characters",rangeLength:"{0} must be between {1} and {2} characters",oneOf:"{0} must be one of: {1}",equalTo:"{0} must be the same as {1}",digits:"{0} must only contain digits",number:"{0} must be a number",email:"{0} must be a valid email",url:"{0} must be a valid url",inlinePattern:"{0} is invalid"},d=r.labelFormatters={none:function(e){return e},sentenceCase:function(e){return e.replace(/(?:^\w|[A-Z]|\b\w)/g,function(e,t){return 0===t?e.toUpperCase():" "+e.toLowerCase()}).replace(/_/g," ")},label:function(e,t){return t.labels&&t.labels[e]||d.sentenceCase(e,t)}},c=r.messageFormatters={none:function(){var e=Array.prototype.slice.call(arguments),t=e.shift();return t.replace(/\{(\d+)\}/g,function(t,i){return"undefined"!=typeof e[i]?e[i]:t})}},h=r.validators=function(){var t=String.prototype.trim?function(e){return null===e?"":String.prototype.trim.call(e)}:function(e){var t=/^\s+/,i=/\s+$/;return null===e?"":e.toString().replace(t,"").replace(i,"")},i=function(t){return e.isNumber(t)||e.isString(t)&&t.match(o.number)},s=function(i){return!(e.isNull(i)||e.isUndefined(i)||e.isString(i)&&""===t(i)||e.isArray(i)&&e.isEmpty(i))},r=function(e,t){return e?e:t};return{format:n.format,formatLabel:n.formatLabel,fn:function(t,i,n,s,r){return e.isString(n)&&(n=s[n]),n.call(s,t,i,r)},inlineFn:function(e,t,i,n,s,r){return i.call(this,e,t,n,s,r)},required:function(t,i,n,o,d){var c=e.isFunction(n)?n.call(o,t,i,d):n;return!(!c&&!s(t))&&(c&&!s(t)?this.format(r(this.msgKey,a.required),this.formatLabel(i,o)):void 0)},acceptance:function(t,i,n,s){if("true"!==t&&(!e.isBoolean(t)||t===!1))return this.format(r(this.msgKey,a.acceptance),this.formatLabel(i,s))},min:function(e,t,n,s){if(!i(e)||e<n)return this.format(r(this.msgKey,a.min),this.formatLabel(t,s),n)},max:function(e,t,n,s){if(!i(e)||e>n)return this.format(r(this.msgKey,a.max),this.formatLabel(t,s),n)},range:function(e,t,n,s){if(!i(e)||e<n[0]||e>n[1])return this.format(r(this.msgKey,a.range),this.formatLabel(t,s),n[0],n[1])},length:function(t,i,n,s){if(!e.isString(t)||t.length!==n)return this.format(r(this.msgKey,a.length),this.formatLabel(i,s),n)},minLength:function(t,i,n,s){if(!e.isString(t)||t.length<n)return this.format(r(this.msgKey,a.minLength),this.formatLabel(i,s),n)},maxLength:function(t,i,n,s){if(!e.isString(t)||t.length>n)return this.format(r(this.msgKey,a.maxLength),this.formatLabel(i,s),n)},rangeLength:function(t,i,n,s){if(!e.isString(t)||t.length<n[0]||t.length>n[1])return this.format(r(this.msgKey,a.rangeLength),this.formatLabel(i,s),n[0],n[1])},oneOf:function(t,i,n,s){if(!e.include(n,t))return this.format(r(this.msgKey,a.oneOf),this.formatLabel(i,s),n.join(", "))},equalTo:function(e,t,i,n,s){if(e!==s[i])return this.format(r(this.msgKey,a.equalTo),this.formatLabel(t,n),this.formatLabel(i,n))},pattern:function(e,t,i,n){if(!s(e)||!e.toString().match(o[i]||i))return this.format(r(this.msgKey,a[i])||a.inlinePattern,this.formatLabel(t,n),i)}}}();return r}),function(e,t){"function"==typeof define&&define.amd?define(["underscore","backbone","./NestedModel","./validation"],t):"object"==typeof exports?module.exports=t(require("underscore"),require("backbone"),require("./NestedModel"),require("./validation")):(e.Torso=e.Torso||{},e.Torso.FormModel=t(e._,e.Backbone,e.Torso.NestedModel,e.Torso.validation))}(this,function(e,t,i,n){"use strict";var s=t.$,r=i.extend({mapping:void 0,models:void 0,constructor:function(t,n){n=n||{},this.__cache={},this.__currentUpdateEvents=[],this.__currentMappings={},this.__currentObjectModels={},this.validation=e.extend({},this.validation,n.validation),this.labels=e.extend({},this.labels,n.labels),i.apply(this,arguments),this.__initMappings(n),this.pull(),t&&this.set(t),n.startUpdating&&this.startUpdating(),this.trigger("initialization-complete")},getMapping:function(e){return this.__currentMappings[e]},getMappings:function(){return this.__currentMappings},setMapping:function(t,i,n,s){var r,o,a={};e.isString(i)?o=i.split(" "):i===!0?o=void 0:e.isObject(i)&&(i=e.clone(i),r=!0),a.computed=r,r?(a.mapping=i,e.each(this.__getModelAliases(a),function(t){var i=a.mapping[t];e.isString(i)?i=i.split(" "):i===!0&&(i=void 0),a.mapping[t]=i})):a.mapping=o,this.__currentMappings[t]=a,n&&(r?this.trackModels(n,s):this.trackModel(t,n,s))},setMappings:function(t,i,n){e.each(t,function(e,t){this.setMapping(t,e)},this),i&&this.trackModels(i,n)},unsetMapping:function(t,i){var n=this.__findAlias(t);n&&delete this.__currentMappings[n];var s=this.getTrackedModel(n);i&&s&&e.isEmpty(this.__getTrackedModelFields(s))&&this.untrackModel(s)},unsetMappings:function(){this.__currentMappings={},this.resetUpdating()},getTrackedModel:function(e){return this.__currentObjectModels[e]},getTrackedModels:function(){return e.values(this.__currentObjectModels)},setTrackedModel:function(){this.trackModel.apply(this,arguments)},trackModel:function(t,i,n){this.__currentObjectModels[t]=i,this.__updateCache(i),this.resetUpdating(),n&&e.each(this.getMappings(),function(i,n){var s;t===n&&this.__pull(n),i.computed&&(s=this.__getModelAliases(n),e.contains(s,t)&&this.__pull(n))},this)},setTrackedModels:function(){this.trackModels.apply(this,arguments)},trackModels:function(t,i){e.each(t,function(e,t){this.trackModel(t,e,i)},this)},unsetTrackedModel:function(){this.untrackModel.apply(this,arguments)},untrackModel:function(e){var t,i=this.__findAlias(e);i&&(t=this.__currentObjectModels[i],delete this.__currentObjectModels[i],this.__updateCache(t)),this.resetUpdating()},unsetTrackedModels:function(){this.untrackModels.apply(this,arguments)},untrackModels:function(){this.__currentObjectModels=[],this.__updateCache(),this.resetUpdating()},push:function(){e.each(this.getMappings(),function(e,t){this.__push(t)},this)},pull:function(){e.each(this.getMappings(),function(e,t){this.__pull(t)},this),this.__updateCache()},save:function(t){var n,r,o=new s.Deferred,a=this;t=t||{},e.defaults(t,{rollback:!0,force:!0});try{r=e.result(a,"url")}catch(d){}return r?i.prototype.save.apply(a,arguments).done(function(){a.push()}):this.isTrackingAnyObjectModel()?(this.__saveToModels(o,t),o.promise()):(n={none:{success:!1,response:[{responseJSON:{generalReasons:[{messageKey:"no.models.were.bound.to.form"}]}}]}},this.trigger("save-fail",n),(new s.Deferred).reject(n).promise())},isTrackingAnyObjectModel:function(){return e.size(this.__currentObjectModels)>0},isUpdating:function(){return this.__currentUpdateEvents.length>0},startUpdating:function(e){this.isTrackingAnyObjectModel()&&!this.isUpdating()&&(e&&this.pull(),this.__setupListeners())},stopUpdating:function(){e.each(this.__currentUpdateEvents,function(e){this.stopListening(e.model,e.eventName)},this),this.__currentUpdateEvents=[]},resetUpdating:function(){this.isUpdating()&&(this.stopUpdating(),this.startUpdating())},isModelStale:function(e,t,i){var n;i=i||{},i[e.cid]||(i[e.cid]=this.__generateHashValue(e)),n=i[e.cid];var s=this.__cache[e.cid]!==n;return t&&(s?t[e.cid]=e:t[e.cid]&&delete t[e.cid]),s},checkIfModelsAreStale:function(){var t={},i=this.__generateAllHashValues();return e.each(this.getTrackedModels(),function(e){this.isModelStale(e,t,i)},this),e.values(t)},__listenToModelField:function(t,i){var n,s;i?(s="change:"+i,n=e.bind(this.__updateFormField,{formModel:this,field:i})):(s="change",n=this.__updateFormModel),this.listenTo(t,s,n),this.__currentUpdateEvents.push({model:t,eventName:s})},__listenToComputedValuesDependency:function(t,i,n){var s,r;r=i?"change:"+i:"change",s=e.bind(this.__invokeComputedPull,{formModel:this,alias:n}),this.listenTo(t,r,s),this.__currentUpdateEvents.push({model:t,eventName:r})},__getComputedModels:function(t){var i=!e.isUndefined(this.getMapping(t)),n={};return e.each(this.__getModelAliases(t),function(e){var t=this.getTrackedModel(e);t?n[e]=t:i=!1},this),i?n:void 0},__getModelAliases:function(t){var i;return i=e.isString(t)?this.getMapping(t):t,e.filter(e.keys(i.mapping),function(e){return"pull"!=e&&"push"!=e})},__getComputedModelConfigs:function(t){var i=!0,n=this.getMapping(t),s=[];return e.each(this.__getModelAliases(t),function(e){var t=this.__createModelConfig(e,n.mapping[e]);t?s.push(t):i=!1},this),i?s:void 0},__saveToModels:function(t,i){function n(n,s,h){d[s.cid]={success:h,response:n},a+o===u&&(a>0?(i.rollback&&e.each(r.getTrackedModels(),function(e){e.set(c[e.cid]),d[e.cid].success&&e.save()}),r.trigger("save-fail",d),t.reject(d)):(r.trigger("save-success",d),t.resolve(d)))}var s,r=this,o=0,a=0,d={},c={},h=r.getTrackedModels(),u=h.length;if(!i.force&&(s=r.checkIfModelsAreStale(),s.length>0))throw{name:"Stale data",staleModels:s};e.each(h,function(e){c[e.cid]=r.__getTrackedModelFields(e)}),r.push(),e.each(h,function(e){e.save().fail(function(){a++,n(arguments,e,!1)}).done(function(){o++,n(arguments,e,!0)})})},__pull:function(t){var i=this.getMapping(t);if(i.computed&&i.mapping.pull)this.__invokeComputedPull.call({formModel:this,alias:t});else if(i.computed){var n=this.__getModelAliases(t);e.each(n,function(e){var t=this.getTrackedModel(e);t&&this.__copyFields(i.mapping[e],this,t)},this)}else{var s=this.getTrackedModel(t);s&&this.__copyFields(i.mapping,this,s)}},__push:function(t){var i=this.getMapping(t);if(i.computed&&i.mapping.push){var n=this.__getComputedModels(t);n&&i.mapping.push.call(this,n)}else if(i.computed){var s=this.__getModelAliases(t);e.each(s,function(e){var t=this.getTrackedModel(e);t&&this.__copyFields(i.mapping[e],t,this)},this)}else{var r=this.getTrackedModel(t);r&&this.__copyFields(i.mapping,r,this)}},__updateFormField:function(e,t){this.formModel.set(this.field,t),this.formModel.__updateCache(e)},__updateFormModel:function(t){e.each(t.changedAttributes(),function(e,t){this.set(t,this.__cloneVal(e))},this),this.__updateCache(t)},__updateCache:function(t){t?this.__cache[t.cid]=this.__generateHashValue(t):(this.__cache={},e.each(this.getTrackedModels(),function(e){e&&this.__updateCache(e)},this))},__hashValue:function(e){return JSON.stringify(e)},__findAlias:function(t){var i,n;return e.isString(t)?i=t:(n=t,i=e.find(this.__currentObjectModels,function(e){return e==n})),i},__generateHashValue:function(e){var t=this.__getTrackedModelFields(e);return this.__hashValue(t)},__generateAllHashValues:function(){var t={};return e.each(this.getTrackedModels(),function(e){t[e.cid]=this.__generateHashValue(e)},this),t},__cloneVal:function(t){var i;if(e.isArray(t))i=[];else{if(!e.isObject(t))return t;i={}}return s.extend(!0,i,t)},__setupListeners:function(){var t,i,n=this;e.each(n.getMappings(),function(s,r){s.computed?(i=n.__getComputedModelConfigs(r),e.each(i,function(t){var i=t.model;t.fields?e.each(t.fields,function(e){n.__listenToComputedValuesDependency(i,e,r)}):n.__listenToComputedValuesDependency(i,"",r)})):(t=n.getTrackedModel(r),t&&(s.mapping?e.each(s.mapping,function(e){n.__listenToModelField(t,e)}):n.__listenToModelField(t)))})},__copyFields:function(t,i,n){(!t||t===!0)&&this===n&&e.size(this.getTrackedModels())>1&&(t=e.keys(i.attributes)),t?e.each(t,function(e){i.set(e,this.__cloneVal(n.get(e)))},this):i.set(this.__cloneVal(n.attributes))},__initMappings:function(t){var i,n,s=e.result(this,"mapping"),r=e.result(this,"models");i=t.mapping||s,n=t.models||r,i&&this.setMappings(i,n)},__getTrackedModelFields:function(t){var i,n={},s={},r=[];return e.each(this.__getAllModelConfigs(),function(e){e.model&&e.model.cid===t.cid&&r.push(e)}),i=e.reduce(r,function(e,t){return e||!t.fields},!1),i?s=this.__cloneVal(t.attributes):e.each(r,function(i){e.each(i.fields,function(e){n[e]||(n[e]=!0,s[e]=this.__cloneVal(t.get(e)))},this)},this),s},__createModelConfig:function(e,t){var i=this.getTrackedModel(e);if(i)return{fields:t,model:i}},__getAllModelConfigs:function(){var t=[];return e.each(this.getMappings(),function(e,i){if(e.computed){var n=this.__getComputedModelConfigs(i);n&&(t=t.concat(n))}else{var s=this.__createModelConfig(i,e.mapping);s&&t.push(s)}},this),t},__invokeComputedPull:function(t){t&&this.formModel.__updateCache(t),function(t,i){var n=!0,s=t.getMapping(i),r=t.__getModelAliases(i),o={};return s.mapping.pull?(e.each(r,function(i){var r=s.mapping[i],a=t.getTrackedModel(i),d={};a?(r?e.each(r,function(e){d[e]=t.__cloneVal(a.get(e))}):d=t.__cloneVal(a.attributes),o[i]=d):n=!1}),void(n&&s.mapping.pull.call(t,o))):void(console&&e.isFunction(console.log)&&console.log("Not pulling the computed: "+i+", because no pull method was defined for this computed."))}(this.formModel,this.alias)}});return e.extend(r.prototype,n.mixin),r}),function(e,t){"function"==typeof define&&define.amd?define(["underscore","backbone","./View","./templateRenderer"],t):"object"==typeof exports?module.exports=t(require("underscore"),require("backbone"),require("./View"),require("./templateRenderer")):(e.Torso=e.Torso||{},e.Torso.ListView=t(e._,e.Backbone,e.Torso.View,e.Torso.Utils.templateRenderer))}(this,function(e,t,i,n){"use strict";var s,r,o,a,d,c,h=t.$;c=function(e){e.__delayedRenderTimeout&&(clearTimeout(e.__delayedRenderTimeout),e.__delayedRenderTimeout=null,e.isDisposed()||e.render())},d=function(e,t){var i=function(){t.__delayedRenderTimeout=null,t.isDisposed()||t.render()};return function(){!t.__delayedRenderTimeout&&e>0?t.__delayedRenderTimeout=setTimeout(i,e):e<=0&&!t.isDisposed()&&t.render()}},s=function(e){var t=this.getItemViewFromModel(e);t&&(r.call(this,t,e[this.__modelId],e),this.hasItemViews()||this.__delayedRender())},r=function(e,t,i){e.dispose(),this.unregisterTrackedView(e,{shared:!1}),delete this.__modelToViewMap[t],this.__updateOrderedModelIdList(),this.trigger("item-view-removed",{model:i||e.model,view:e}),this.trigger("child-view-removed",{model:i||e.model,view:e})},o=function(e){var t,i=this.modelsToRender(),n=i.indexOf(e);n>-1&&(t=this.__createItemView(e),a.call(this,t,n))},a=function(t,i){var n,s,r,o=this.modelsToRender();this.hasItemViews()?(c(this),n=this.getItemViewFromModel(o[i+1]),s=this.getItemViewFromModel(o[i-1]),n?r=e.bind(n.$el.before,n.$el):s?r=e.bind(s.$el.after,s.$el):this.__delayedRender(),r&&this.attachView(null,t,{replaceMethod:r,discardInjectionSite:!0})):this.__delayedRender()};var u=i.extend({collection:null,itemView:null,template:null,emptyTemplate:null,itemContainer:null,__modelName:"",__modelId:"",__modelToViewMap:null,__itemContext:null,__renderWait:0,__delayedRender:null,__delayedRenderTimeout:null,constructor:function(e){i.apply(this,arguments),e=e||{};var t=e.collection||this.collection;if(this.template=e.template||this.template,this.emptyTemplate=e.emptyTemplate||this.emptyTemplate,this.itemView=e.itemView||this.itemView,this.itemContainer=e.itemContainer||this.itemContainer,this.template&&!this.itemContainer)throw"Item container is required when using a template";this.modelsToRender=e.modelsToRender||this.modelsToRender,this.__itemContext=e.itemContext||this.__itemContext,this.__modelToViewMap={},this.__renderWait=e.renderWait||this.__renderWait,this.__modelId=e.modelId||this.modelId||"cid",this.__modelName=e.modelName||this.modelName||"model",this.__orderedModelIdList=[],this.__createItemViews(),this.__delayedRender=d(this.__renderWait,this),t&&this.setCollection(t,!0),this.on("render:after-dom-update",this.__cleanupItemViewsAfterAttachedToParent)},setCollection:function(e,t){this.stopListening(this.collection,"remove",s),this.stopListening(this.collection,"add",o),this.stopListening(this.collection,"sort",this.reorder),this.stopListening(this.collection,"reset",this.update),this.collection=e,this.listenTo(this.collection,"remove",s),this.listenTo(this.collection,"add",o),this.listenTo(this.collection,"sort",this.reorder),this.listenTo(this.collection,"reset",this.update),t||this.update()},updateDOM:function(){var e,t=h(n.copyTopElement(this.el));this.template?(t.html(this.template(this.prepare())),e=t.find("[inject="+this.itemContainer+"]")):(e=h("<span>"),t.append(e)),this.hasItemViews()?e.replaceWith(this.__emptyAndRebuildItemViewsFragment()):this.emptyTemplate&&e.replaceWith(this.emptyTemplate(this.prepareEmpty())),this.$el.html(t.contents())},__cleanupItemViewsAfterAttachedToParent:function(){e.each(this.modelsToRender(),function(e){var t=this.getItemViewFromModel(e);t&&(t.delegateEvents(),!t.__attachedCallbackInvoked&&t.isAttached()&&t.__invokeAttached(),t.activate())},this)},renderChildViews:function(){e.each(this.getTrackedViews({child:!0}),function(e){e.render()})},reorder:function(){var t,i,n=[],s=this.modelsToRender(),r=e.pluck(s,this.__modelId),o=e.size(r),a=e.size(this.__orderedModelIdList),d=o===a;if(!d)throw"Reorder should not be invoked if the number of models have changed";if(i=e.reduce(this.__orderedModelIdList,function(e,t,i){return e&&r[i]==t},!0),o&&!i){if(e.each(s,function(e,i){var s=this.getItemViewFromModel(e);s&&n.push(s.$el),0===i&&(t=s)},this),this.itemContainer){if(t){var c=h("<span>");t.$el.before(c),c.after(n),c.remove()}}else this.$el.append(n);this.__updateOrderedModelIdList(r),this.trigger("reorder-complete")}},prepareEmpty:function(){return this.prepare()},modelsToRender:function(){return this.collection?this.collection.models:[]},update:function(){var t=this.getItemViews(),i=this.__createItemViews(),n=this.__getStaleItemViews(),s=e.size(t),r=e.size(i),o=e.size(n),a=s-o+r,d=r+o,c=d/Math.max(a,1),h=!s&&r,u=s&&s===o&&!r,l=this.updateThreshold||.5,f=c>=l;if(d<=0)return this.reorder();var p=h||u||f;p?(this.__removeStaleItemViews(n),this.__delayedRender()):this.__updateByAddingRemoving(t,i,n)},getItemViewFromModel:function(e){return e?this.getTrackedView(this.__modelToViewMap[e[this.__modelId]]):void 0},hasItemViews:function(){return!e.isEmpty(this.getItemViews())},getItemViews:function(){var t=e.map(this.__orderedModelIdList,this.__getViewIdFromModelId,this);return e.map(t,this.getTrackedView,this)},__createItemViews:function(){var t=[];return e.each(this.modelsToRender(),function(e,i){var n=this.getItemViewFromModel(e);n||t.push({view:this.__createItemView(e,!0),indexOfModel:i})},this),this.__updateOrderedModelIdList(),t},__createItemView:function(t,i){var n,s=this.itemView;return e.isFunction(this.itemView.extend)||(s=this.itemView(t)),n=new s(this.__generateItemViewArgs(t)),this.registerTrackedView(n,{shared:!1}),this.__modelToViewMap[t[this.__modelId]]=n.cid,i||this.__updateOrderedModelIdList(),this.trigger("child-view-added",{model:t,view:n}),this.trigger("item-view-added",{model:t,view:n}),n},__getStaleItemViews:function(){var t=[],i=e.clone(this.__modelToViewMap);return e.each(this.modelsToRender(),function(e){var t=this.getItemViewFromModel(e);t&&delete i[e[this.__modelId]]},this),e.each(i,function(e,i){var n=this.getTrackedView(e);n&&t.push({view:n,modelId:i})},this),t},__removeStaleItemViews:function(t){var i=this;t=t||this.__getStaleItemViews(),e.each(t,function(e){r.call(i,e.view,e.modelId)})},__emptyAndRebuildItemViewsFragment:function(){var t=document.createDocumentFragment();return this.$el.empty(),e.each(this.modelsToRender(),function(e){var i=this.getItemViewFromModel(e);i&&(i.detach(),this.registerTrackedView(i,{shared:!1}),i.attachTo(null,{replaceMethod:function(e){t.appendChild(e[0])},discardInjectionSite:!0}))},this),this.__updateOrderedModelIdList(),h(t)},__updateByAddingRemoving:function(t,i,n){var s,r,o=this,d=e.size(t),c=(e.size(i),e.size(n));o.itemContainer&&d&&d==c&&(r=h("<span>"),e.first(t).$el.before(r)),o.__removeStaleItemViews(n),e.each(i,function(t,i){if(0===t.indexOfModel){var d;if(o.itemContainer)if(r)d=e.bind(r.replaceWith,r);else{var c=e.indexBy(n,"modelId"),h=e.find(o.__orderedModelIdList,function(e){return!c[e]});s=o.getTrackedView(o.__modelToViewMap[h]),d=e.bind(s.$el.prepend,s.$el)}else d=e.bind(o.$el.prepend,o.$el);o.attachView(null,t.view,{replaceMethod:d,discardInjectionSite:!0})}else a.call(o,t.view,t.indexOfModel)}),this.reorder()},__updateOrderedModelIdList:function(t){this.__orderedModelIdList=t||e.pluck(this.modelsToRender(),this.__modelId)},__generateItemViewArgs:function(t){var i={context:e.extend({},e.result(this,"__itemContext")),listView:this};return i[this.__modelName]=t,i},__generateChildArgs:function(){return this.__generateItemViewArgs.apply(this,arguments)},__getViewIdFromModelId:function(e){return this.__modelToViewMap[e]}});return u}),function(e,t){if("function"==typeof define&&define.amd)define(["underscore","backbone","../Behavior","../Collection","../Events"],t);else if("object"==typeof exports){var i=require("underscore"),n=require("backbone"),s=require("../Behavior"),r=require("../Collection"),o=require("../Events");module.exports=t(i,n,s,r,o)}else e.Torso=e.Torso||{},e.Torso.behaviors=e.Torso.behaviors||{},e.Torso.behaviors.DataBehavior=t(e._,e.Backbone,e.Torso.Behavior,e.Torso.Collection,e.Torso.Events)}(this,function(e,t,i,n,s){"use strict";function r(t){return e.isArray(t)?(t=e.flatten(t),e.uniq(t)):e.isString(t)||e.isNumber(t)?[t]:t&&t.skipObjectRetrieval?t:void 0}function o(t){return(e.isUndefined(t)||e.isNull(t))&&(t=[]),t}function a(t,i){i=i.replace(/\[(\w+)\]/g,".$1"),i=i.replace(/^\./,"");var n=i.split(h);return e.reduce(n,function(t,i){return e.isUndefined(t)?void 0:t[i]},t)}function d(e){return!!e&&e.indexOf(u)>-1}var c=t.$,h=".",u=":",l={SUCCESS:"success",FAILURE:"failed"},f=i.extend({cache:void 0,renderOnFetch:!1,skipInitialLoad:!1,returnSingleResult:!1,alwaysFetch:!1,ids:void 0,updateEvents:void 0,data:void 0,FETCHED_STATUSES:l,constructor:function(t,n,s){e.bindAll(this,"__skipRetrieveOnEmptyTrackedIdsAndNewIds","__completeLoadingIds","__fetchSuccess","__fetchFailed","__abortIfDisposed"),n=n||{},n=e.defaults(n,{alwaysFetch:!1}),e.extend(this,e.pick(n,"cache","id","ids","renderOnFetch","skipInitialLoad","returnSingleResult","alwaysFetch","updateEvents")),this.__validateCache(),this.__normalizeAndValidateIds(),this.__normalizeAndValidateUpdateEvents(),this.cid=this.cid||e.uniqueId(this.cidPrefix),this.data=new this.Data({parentBehavior:this,privateCollection:this.cache.createPrivateCollection(this.cid)}),i.apply(this,arguments),this.set("loadingIds",0),this.on("id-container-updated",this.listenToIdsPropertyChangeEvent),this.on("id-container-updated",this.retrieve),this.listenTo(this.view,"initialize:complete",this.listenToIdsPropertyChangeEvent),this.listenTo(this.view,"initialize:complete",this._delegateUpdateEvents),this.skipInitialLoad||this.listenTo(this.view,"initialize:complete",this.retrieve),this.on("fetched",function(){this.renderOnFetch&&this.view.isActive()&&this.view.isAttached()&&this.view.render()}),this.listenTo(this.view,"before-dispose-callback",this.data.dispose)},retrieve:function(){return this.alwaysFetch?this.fetch():this.pull()},pull:function(){var e=this;return this.__getIds().then(this.__skipRetrieveOnEmptyTrackedIdsAndNewIds).then(this.__abortIfDisposed).then(function(t){return t&&!t.skipObjectRetrieval?e.data.privateCollection.trackAndPull(t):t},function(e){return e.failedOnIds=!0,e}).then(this.__fetchSuccess,this.__fetchFailed)},fetch:function(){var e=this;return this.__getIds().then(this.__skipRetrieveOnEmptyTrackedIdsAndNewIds).then(this.__abortIfDisposed).then(function(t){return t&&!t.skipObjectRetrieval?e.data.privateCollection.trackAndFetch(t):t},function(e){return e.failedOnIds=!0,e}).then(this.__fetchSuccess,this.__fetchFailed)},prepare:function(){var e=i.prototype.prepare.apply(this)||{};return e.data=this.data.toJSON(),e.loading=this.isLoading(),e.loadingIds=this.isLoadingIds(),e.loadingObjects=this.isLoadingObjects(),e},isLoading:function(){return this.isLoadingIds()||this.isLoadingObjects()},isLoadingIds:function(){return this.get("loadingIds")>0},isLoadingObjects:function(){return this.data.privateCollection.isLoading()},listenToIdsPropertyChangeEvent:function(){if(!e.isUndefined(this.ids.property)){this.stopListeningToIdsPropertyChangeEvent();var t=this.__parseIdsPropertyNameAndIdContainer(),i=t.idContainer,n=i&&e.isFunction(i.on);n&&(this.__currentContextWithListener=i,this.__currentContextEventName="change:"+t.idsPropertyName,this.listenTo(this.__currentContextWithListener,this.__currentContextEventName,this.retrieve),this.listenTo(this.__currentContextWithListener,"fetched:ids",this.retrieve))}},stopListeningToIdsPropertyChangeEvent:function(){this.__currentContextWithListener&&(this.stopListening(this.__currentContextWithListener,this.__currentContextEventName,this.retrieve),this.stopListening(this.__currentContextWithListener,"fetched:ids",this.retrieve),delete this.__currentContextWithListener,delete this.__currentContextEventName)},retrieveOncePromise:function(){var e=c.Deferred(),t=this.get("fetchSuccess");return t?e.resolve():t===!1?e.reject():this.once("fetched",function(){var t=this.get("fetchSuccess");t?e.resolve():e.reject()}),e.promise()},_delegateUpdateEvents:function(){this._undelegateUpdateEvents();var t=this.__parseUpdateEvents();e.each(t,function(e){this.listenTo(e.idContainer,e.eventName,this.retrieve)},this)},_undelegateUpdateEvents:function(){var t=this.__parseUpdateEvents();e.each(t,function(e){this.stopListening(e.idContainer,e.eventName,this.retrieve)},this)},__parseUpdateEvents:function(){
this.__normalizeAndValidateUpdateEvents();var t=e.flatten(e.map(this.updateEvents,this.__parseUpdateEvent,this));return e.compact(t)},__parseUpdateEvent:function(t){if(!e.isUndefined(t)){var i=[];if(e.isString(t)){var n=this.__parseStringUpdateEvent(t);e.isUndefined(n)||i.push(n)}else e.isObject(t)&&(i=e.map(t,function(e,t){return{idContainer:e,eventName:t}}));return i}},__validateCache:function(){if(!this.cache)throw new Error("Torso Data Behavior constructed without a cache");if(!(this.cache instanceof n))throw new Error("Torso Data Behavior's cache is not of type Torso.Collection")},__normalizeAndValidateIds:function(){if(!e.isUndefined(this.ids)&&!e.isUndefined(this.id))throw new Error("Torso Data Behavior constructed with both id and ids.  Please define only one.");this.ids=this.id||this.ids,this.__validateIds()},__validateIds:function(){if(e.isUndefined(this.ids))throw new Error("Torso Data Behavior constructed without a way to identify the ids for this data.  Please define either id, ids.");var t=e.isArray(this.ids),i=e.isString(this.ids)||e.isNumber(this.ids),n=e.isFunction(this.ids),s=e.isString(this.ids.property),r=e.isObject(this.ids),o=t||i||n||s;if(!o&&r)throw new Error("Data Behavior ids invalid definition.  It is an object, but the property field is not defined or is not a string: "+JSON.stringify(this.ids));if(!o)throw new Error("Data Behavior ids invalid definition.  Not a string, number, object, array or function: "+JSON.stringify(this.ids));if(s){var a=d(this.ids.property),c=!e.isUndefined(this.ids.idContainer);if(c&&a)throw new Error("Data Behavior ids invalid definition.  Id container defined on both ids.property and ids.idContainer: ",JSON.stringify(this.ids))}},__normalizeAndValidateUpdateEvents:function(){var t=e.isArray(this.updateEvents),i=!t&&(e.isObject(this.updateEvents)||e.isString(this.updateEvents)),n=e.isUndefined(this.updateEvents),s=t||i||n;if(i&&(this.updateEvents=[this.updateEvents]),!s)throw new Error("Update events are not an array, string or object.  Please see parameters for examples of how to define updateEvents.  Configured UpdateEvents: ",this.updateEvents);this.updateEvents=e.compact(this.updateEvents),e.each(this.updateEvents,this.__validUpdateEvent)},__validUpdateEvent:function(t){var i=e.isString(t),n=e.isObject(t)&&e.keys(t).length>0;if(!i&&!n)throw new Error("Not a valid updateEvent configuration.  Update events need to either be strings or objects with a single property: "+JSON.stringify(t))},__getIds:function(){this.set("loadingIds",this.get("loadingIds")+1),this.__validateIds();var t=c.Deferred(),i=this.ids,n=r(i);if(e.isUndefined(n)){if(e.isFunction(this.ids))i=this.ids(this.cache),n=r(i),e.isUndefined(n)?i&&e.isFunction(i.then)?t=i.then(r):t.resolve([]):t.resolve(n);else if(!e.isUndefined(this.ids.property)){var s=this.__parseIdsPropertyNameAndIdContainer(),d=s.idsPropertyName,h=s.idContainer;i=a(h,d);var u=h&&e.isUndefined(i),l=h&&e.isFunction(h.get);u&&l&&(i=h.get(d)),n=r(i),t.resolve(n)}}else t.resolve(n);return t.promise().then(o).always(this.__completeLoadingIds)},__completeLoadingIds:function(){this.set("loadingIds",this.get("loadingIds")-1)},__parseIdsPropertyNameAndIdContainer:function(){var t,i=this.ids.property,n=d(i),s=!e.isUndefined(this.ids.idContainer);if(s&&(t=this.__parseIdContainer()),n){var r=this.__parseContainerDetailString(i);i=r.detail,t=r.idContainer}return e.isUndefined(t)&&(t=this.view),{idsPropertyName:i,idContainer:t}},__parseIdContainer:function(){var t,i=this.ids.idContainer;if(e.isUndefined(i))t=void 0;else if(e.isFunction(i)){var n=e.bind(i,this);t=n()}else{if(!e.isObject(i))throw new Error("Invalid idContainer.  Not an object or function: "+JSON.stringify(this.ids));t=i}return t},__parseContainerDetailString:function(e){var t="";d(e)&&(t=e.split(u,1)[0]);var i,n=t.split(h),s=n[0];if("this"===s)i=this;else if("behaviors"===s||"behavior"===s){var r=n[1];s+=h+r,i=this.view.getBehavior(r)}else"view"!==s&&(s=""),i=this.view;var o=i,c=t.replace(s,"");c&&(c[0]===h&&(c=c.slice(1)),o=a(i,c));var l=e.replace(t+u,"");return{detail:l,idContainer:o}},__parseStringUpdateEvent:function(e){var t=this.__parseContainerDetailString(e);if(t)return{idContainer:t.idContainer,eventName:t.detail}},__abortIfDisposed:function(){var e=c.Deferred();if(this.isDisposed()){var t=Array.prototype.slice.call(arguments);t.push("Data Behavior disposed, aborting."),e.reject.apply(e,t)}else e.resolve.apply(e,arguments);return e.promise()},__fetchSuccess:function(e){return this.set("fetchSuccess",!0),this.set("fetchedOnce",!0),this.__shouldTriggerFetchedEvent(e)&&(this.trigger("fetched",{status:l.SUCCESS,response:e}),this.data.trigger("fetched",{status:l.SUCCESS,response:e})),this.trigger("fetched:ids"),this.data.trigger("fetched:ids"),e},__fetchFailed:function(e){return this.set("fetchSuccess",!1),this.set("fetchedOnce",!0),this.__shouldTriggerFetchedEvent(e)&&(this.trigger("fetched",{status:l.FAILURE,response:e}),this.data.trigger("fetched",{status:l.FAILURE,response:e}),e&&e.emptyIds&&(this.__firstEmptyFetchedTriggered=!0)),this.trigger("fetched:ids"),this.data.trigger("fetched:ids"),e},__shouldTriggerFetchedEvent:function(e){return!e||!e.skipObjectRetrieval||e.forceFetchedEvent},__skipRetrieveOnEmptyTrackedIdsAndNewIds:function(t){return e.isEmpty(t)&&e.isEmpty(this.data.privateCollection.getTrackedIds())?{skipObjectRetrieval:!0,forceFetchedEvent:!0}:t},_activate:function(){this.listenToIdsPropertyChangeEvent(),this._delegateUpdateEvents(),this.data.activate()},_deactivate:function(){this.stopListeningToIdsPropertyChangeEvent(),this._undelegateUpdateEvents(),this.data.deactivate()}}),p=function(e){this.initialize(e)};return e.extend(p.prototype,s,{initialize:function(t){this.parentBehavior=t.parentBehavior,this.privateCollection=t.privateCollection,e.bindAll(this,"dispose")},isLoading:function(){return this.parentBehavior.isLoading()},isLoadingIds:function(){return this.parentBehavior.isLoadingIds()},isLoadingObjects:function(){return this.parentBehavior.isLoadingObjects()},toJSON:function(){var e=this.privateCollection;if(!this.parentBehavior.returnSingleResult)return e.toJSON();if(0!==e.length){if(1===e.length){var t=e.at(0);return t.toJSON()}throw new Error("Multiple results found, but single result expected: "+JSON.stringify(e.toJSON()))}},get:function(t){var i=this.privateCollection;if(!this.parentBehavior.returnSingleResult)return e.isString(t)?i.pluck(t):i.toJSON();var n=this.getModel();return n?e.isString(t)?n.get(t):n.toJSON():void 0},getModel:function(t){var i=this.privateCollection;if(!this.parentBehavior.returnSingleResult&&e.isUndefined(t))throw new Error("data.getModel() of a DataBehavior is only valid if the behavior is set to returnSingleResult === true");if(!e.isUndefined(t))return i.get(t);if(0!==i.length){if(1===i.length)return i.at(0);throw new Error("Multiple results found, but single result expected: "+JSON.stringify(i.toJSON()))}},getModels:function(){return this.privateCollection.models.slice(0)},activate:function(){this.listenTo(this.privateCollection,"all",this.trigger)},deactivate:function(){this.stopListening(this.privateCollection,"all",this.trigger)},dispose:function(){this.off(),this.stopListening(),this.privateCollection.dispose()}}),f.prototype.Data=p,f.FETCHED_STATUSES=l,f}),function(e,t){"function"==typeof define&&define.amd?define(["underscore","backbone","./View","./FormModel","./Cell","backbone.stickit"],t):"object"==typeof exports?(require("backbone.stickit"),module.exports=t(require("underscore"),require("backbone"),require("./View"),require("./FormModel"),require("./Cell"))):(e.Torso=e.Torso||{},e.Torso.FormView=t(e._,e.Backbone,e.Torso.View,e.Torso.FormModel,e.Torso.Cell))}(this,function(e,t,i,n,s){"use strict";var r=t.$,o=i.extend({constructor:function(t){t=t||{};var s=t.FormModelClass||this.FormModelClass||n;this.model=t.model||this.model||new s,this.template=t.template||this.template,this.events=e.extend({},this.events||{},t.events||{}),this.fields=e.extend({},this.fields||{},t.fields||{}),this._errors=[],this._success=!1,this._bindings=e.extend({},this.bindings||{},t.bindings||{}),i.apply(this,arguments),this.resetModelListeners(this.model)},prepare:function(){var t=i.prototype.prepare.apply(this);return t.formErrors=0!==e.size(this._errors)?this._errors:null,t.formSuccess=this._success,t},delegateEvents:function(){this.__generateStickitBindings(),this.stickit(),i.prototype.delegateEvents.call(this)},resetModelListeners:function(e,t){this.model&&t&&this.stopListening(this.model),this.model=e,this.listenTo(this.model,"validated:valid",this.valid),this.listenTo(this.model,"validated:invalid",this.invalid)},valid:function(){this._success=!0,this._errors=[]},invalid:function(e,t){this._success=!1,this._errors=t},deactivate:function(){i.prototype.deactivate.call(this),this.unstickit()},_thenAddClassIfInvalid:function(e,t,i){var n=this.model.isValid(e);return!!i==!!n?{addClass:t}:{removeClass:t}},_thenSetTextIfInvalid:function(e,t,i){var n=this.model.isValid(e);return!!i==!!n?{text:t}:{text:""}},__generateStickitBindings:function(){var t=this;this.bindings=e.extend({},this._bindings),e.each(this.$("[data-model]"),function(e){var i=r(e).data("model"),n=t.__getFieldOptions(i),s=t.__generateModelFieldBinding(i,n);r(e).is("select")&&(s.selectOptions=t.__generateSelectOptions(e,n)),t.bindings['[data-model="'+i+'"]']=s})},__getFieldOptions:function(e){return e=this.__stripAllAttribute(e),this.fields[e]||{}},__generateModelFieldBinding:function(t,i){var n=this.__getAllIndexTokens(t);return{observe:t,onSet:function(t){var s=[t];return s.push(n),s=e.flatten(s),i.modelFormat?i.modelFormat.apply(this,s):t},onGet:function(t){var s=[t];return s.push(n),s=e.flatten(s),i.viewFormat?i.viewFormat.apply(this,s):t}}},__generateSelectOptions:function(t,i){var n=[],s=r(t).children("option");return e.each(s,function(e){n.push({label:r(e).text(),value:i.modelFormat?i.modelFormat.apply(this,[r(e).val()]):r(e).val()})}),{collection:n,labelPath:"label",valuePath:"value"}}});return o});